<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>qmuvi.video_generation &mdash; qMuVi 0.1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #000a0a" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/logo_black.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../winning_project_link.html">qMuVi: Qiskit Hackathon Winner 2022</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../how_it_works_link.html">How it Works</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mapping_quantum_to_music_link.html">Mapping Quantum to Music</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">qmuvi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing_link.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors_link.html">Authors</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #000a0a" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">qMuVi</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../qmuvi.html">qmuvi</a></li>
      <li class="breadcrumb-item active">qmuvi.video_generation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for qmuvi.video_generation</h1><div class="highlight"><pre>
<span></span><span class="c1"># Methods relating to the generation of video from sampled density matrices</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">Iterable</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">moviepy.editor</span> <span class="k">as</span> <span class="nn">mpy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">qiskit</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">ListedColormap</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="kn">import</span> <span class="n">Line2D</span>
<span class="kn">from</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">from</span> <span class="nn">moviepy.audio.AudioClip</span> <span class="kn">import</span> <span class="n">CompositeAudioClip</span>
<span class="kn">from</span> <span class="nn">moviepy.editor</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CompositeVideoClip</span><span class="p">,</span>
    <span class="n">ImageClip</span><span class="p">,</span>
    <span class="n">VideoClip</span><span class="p">,</span>
    <span class="n">clips_array</span><span class="p">,</span>
    <span class="n">concatenate</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">moviepy.video.fx</span> <span class="kn">import</span> <span class="n">crop</span><span class="p">,</span> <span class="n">invert_colors</span>
<span class="kn">from</span> <span class="nn">moviepy.video.io.bindings</span> <span class="kn">import</span> <span class="n">mplfig_to_npimage</span>
<span class="kn">from</span> <span class="nn">qiskit</span> <span class="kn">import</span> <span class="n">QuantumCircuit</span>
<span class="kn">from</span> <span class="nn">qiskit.converters</span> <span class="kn">import</span> <span class="n">circuit_to_dag</span>

<span class="kn">import</span> <span class="nn">qmuvi.data_manager</span> <span class="k">as</span> <span class="nn">data_manager</span>

<span class="n">Colour</span> <span class="o">=</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>


<div class="viewcode-block" id="convert_colour_to_uint8"><a class="viewcode-back" href="../../qmuvi.html#qmuvi.video_generation.convert_colour_to_uint8">[docs]</a><span class="k">def</span> <span class="nf">convert_colour_to_uint8</span><span class="p">(</span><span class="n">colour</span><span class="p">:</span> <span class="n">Colour</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Colour</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a colour to the uint8 format used by matplotlib.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        colour</span>
<span class="sd">            The colour to convert. This can be an iterable of ints or floats.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The converted colour, represented as an iterable of uint8s.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colour</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">colour</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">colour</span><span class="p">]</span></div>


<div class="viewcode-block" id="convert_colour_to_float"><a class="viewcode-back" href="../../qmuvi.html#qmuvi.video_generation.convert_colour_to_float">[docs]</a><span class="k">def</span> <span class="nf">convert_colour_to_float</span><span class="p">(</span><span class="n">colour</span><span class="p">:</span> <span class="n">Colour</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Colour</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a colour to the float range [0, 1] used by matplotlib.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        colour</span>
<span class="sd">            The colour to convert. This can be an iterable of ints or floats.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The converted colour, represented as an iterable of floats.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colour</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">colour</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="o">/</span> <span class="mf">255.0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">colour</span><span class="p">]</span></div>


<div class="viewcode-block" id="filter_blend_colours"><a class="viewcode-back" href="../../qmuvi.html#qmuvi.video_generation.filter_blend_colours">[docs]</a><span class="k">def</span> <span class="nf">filter_blend_colours</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Colour</span><span class="p">]],</span> <span class="n">colour</span><span class="p">:</span> <span class="n">Colour</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Colour</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Applies alpha blending to each pixel in an image using a specified colour and alpha value.</span>

<span class="sd">    This function takes an image represented as a 2D array of colours, and applies alpha blending to</span>
<span class="sd">    each individual pixel in the bitmap. The blending is done using a specified colour and alpha value,</span>
<span class="sd">    with the resulting colour being a weighted average of the original pixel colour and the specified colour.</span>
<span class="sd">    The blended colour will have the minimum number of channels of the two input colours. For example, blending</span>
<span class="sd">    an RGB colour with an RGBA colour will result in an RGB colour.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        image</span>
<span class="sd">            The image to be blended.</span>
<span class="sd">        colour</span>
<span class="sd">            The colour to blend with the image.</span>
<span class="sd">        alpha</span>
<span class="sd">            A value ranging from 0.0 (fully pixel colour) to 1.0 (fully colour) that specifies the weight of the</span>
<span class="sd">            colour in the blend. If the alpha value is outside the [0, 1] range, it will be clamped to this range.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The filtered image, represented as a 2D array of colours.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
            <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">blend_colours</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">colour</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">image</span></div>


<div class="viewcode-block" id="blend_colours"><a class="viewcode-back" href="../../qmuvi.html#qmuvi.video_generation.blend_colours">[docs]</a><span class="k">def</span> <span class="nf">blend_colours</span><span class="p">(</span><span class="n">colour1</span><span class="p">:</span> <span class="n">Colour</span><span class="p">,</span> <span class="n">colour2</span><span class="p">:</span> <span class="n">Colour</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Colour</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Blends two colours together using the specified alpha value as a weighted average.</span>

<span class="sd">    The blended colour will have the minimum number of channels of the two input colours. For example, blending an RGB colour</span>
<span class="sd">    with an RGBA colour will result in an RGB colour.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        colour1</span>
<span class="sd">            The first colour to be blended.</span>
<span class="sd">        colour2</span>
<span class="sd">            The second colour to be blended.</span>
<span class="sd">        alpha</span>
<span class="sd">            A value ranging from 0.0 (fully colour1) to 1.0 (fully colour2) that specifies the weight of the</span>
<span class="sd">            second colour in the blend. If the alpha value is outside the [0, 1] range, it will be clamped to this range.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The blended colour with the lesser number of channels of the two input colours.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colour1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">colour1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">colour2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colour2</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">colour1</span><span class="p">)))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">colour1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">colour2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colour2</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">colour1</span><span class="p">)))]</span></div>


<div class="viewcode-block" id="filter_colour_multiply"><a class="viewcode-back" href="../../qmuvi.html#qmuvi.video_generation.filter_colour_multiply">[docs]</a><span class="k">def</span> <span class="nf">filter_colour_multiply</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Colour</span><span class="p">]],</span> <span class="n">colour</span><span class="p">:</span> <span class="n">Colour</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Colour</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Multiplies each pixel in an image with a specified colour.</span>

<span class="sd">    This function takes an image represented as a 2D array of colours and multiplies each individual pixel in the</span>
<span class="sd">    bitmap with a specified colour. The resulting colour is obtained by multiplying the values of each colour channel</span>
<span class="sd">    of the original pixel with the corresponding values in the specified colour. The blended pixel colours will have</span>
<span class="sd">    the lesser number of channels of the two input colours. For example, blending an RGB colour</span>
<span class="sd">    with an RGBA colour will result in an RGB colour.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        image</span>
<span class="sd">            The image to be filtered.</span>
<span class="sd">        colour</span>
<span class="sd">            The colour to multiply with the image.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The filtered image, represented as a 2D Iterable of colours. The blended pixel colours will have the lesser number of channels of the two input colours.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">colour</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">colour</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colour</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])))]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
                <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">colour</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colour</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])))]</span>

    <span class="k">return</span> <span class="n">image</span></div>


<div class="viewcode-block" id="lerp"><a class="viewcode-back" href="../../qmuvi.html#qmuvi.video_generation.lerp">[docs]</a><span class="k">def</span> <span class="nf">lerp</span><span class="p">(</span><span class="n">start_values</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">end_values</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interpolates between two iterable sequences of values using linear interpolation.</span>

<span class="sd">    This function takes two iterables of start and end values and a float representing a time t in the range [0, 1],</span>
<span class="sd">    and performs linear interpolation between the two values based on the value of t. The result of the linear</span>
<span class="sd">    interpolation is an iterable of floats that is the same length as the input iterables.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        start_values</span>
<span class="sd">            The start values for the linear interpolation. An iterable of floats.</span>
<span class="sd">        end_values</span>
<span class="sd">            The end values for the linear interpolation. An iterable of floats.</span>
<span class="sd">        t</span>
<span class="sd">            A float in the range [0, 1] that represents the time between the start and end values. If t=0, the result</span>
<span class="sd">            will be equal to the start values, if t=1, the result will be equal to the end values. If t is outside the</span>
<span class="sd">            range [0, 1], it will be clamped.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        A list of floats representing the result of the linear interpolation between the start and end values.</span>
<span class="sd">        The resulting list will have the same length as the input iterables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_values</span><span class="p">,</span> <span class="n">end_values</span><span class="p">)]</span></div>


<div class="viewcode-block" id="ease_in"><a class="viewcode-back" href="../../qmuvi.html#qmuvi.video_generation.ease_in">[docs]</a><span class="k">def</span> <span class="nf">ease_in</span><span class="p">(</span><span class="n">start_values</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">end_values</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interpolates between two values using an ease-in curve.</span>

<span class="sd">    This function takes two iterables of start and end values and a float representing a time t in the range [0, 1],</span>
<span class="sd">    and performs interpolation between the two values using an ease-in curve based on the value of t. The ease-in curve</span>
<span class="sd">    starts slowly and speeds up as it approaches the end value. The result of the interpolation is an iterable of floats</span>
<span class="sd">    that is the same length as the input iterables.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        start_values</span>
<span class="sd">            The start values for the interpolation. An iterable of floats.</span>
<span class="sd">        end_values</span>
<span class="sd">            The end values for the interpolation. An iterable of floats.</span>
<span class="sd">        t</span>
<span class="sd">            A float in the range [0, 1] that represents the time between the start and end values. If t=0, the result</span>
<span class="sd">            will be equal to the start values, if t=1, the result will be equal to the end values. If t is outside the</span>
<span class="sd">            range [0, 1], it will be clamped.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        A list of floats representing the result of the interpolation using an ease-in curve between the start</span>
<span class="sd">        and end values. The resulting list will have the same length as the input iterables.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">scaled_t</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">scaled_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">scaled_t</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_values</span><span class="p">,</span> <span class="n">end_values</span><span class="p">)]</span></div>


<div class="viewcode-block" id="ease_out"><a class="viewcode-back" href="../../qmuvi.html#qmuvi.video_generation.ease_out">[docs]</a><span class="k">def</span> <span class="nf">ease_out</span><span class="p">(</span><span class="n">start_values</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">end_values</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Interpolates between two values using an ease-out curve.</span>

<span class="sd">    This function takes two iterables of start and end values and a float representing a time t in the range [0, 1],</span>
<span class="sd">    and performs interpolation between the two values using an ease-out curve based on the value of t. The ease-out curve</span>
<span class="sd">    starts quickly and slows down as it approaches the end value. The result of the interpolation is an iterable of</span>
<span class="sd">    floats that is the same length as the input iterables.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        start_values</span>
<span class="sd">            The start values for the interpolation. An iterable of floats.</span>
<span class="sd">        end_values</span>
<span class="sd">            The end values for the interpolation. An iterable of floats.</span>
<span class="sd">        t</span>
<span class="sd">            A float in the range [0, 1] that represents the time between the start and end values. If t=0, the result</span>
<span class="sd">            will be equal to the start values, if t=1, the result will be equal to the end values. If t is outside the</span>
<span class="sd">            range [0, 1], it will be clamped.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        A list of floats representing the result of the interpolation using an ease-out curve between the start</span>
<span class="sd">        and end values. The resulting list will have the same length as the input iterables.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">scaled_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">scaled_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">scaled_t</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_values</span><span class="p">,</span> <span class="n">end_values</span><span class="p">)]</span></div>


<div class="viewcode-block" id="invert_cmap"><a class="viewcode-back" href="../../qmuvi.html#qmuvi.video_generation.invert_cmap">[docs]</a><span class="k">def</span> <span class="nf">invert_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Colormap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inverts the colors of a Matplotlib colormap.</span>

<span class="sd">    This function takes a Matplotlib colormap object and returns a new colormap with the colors inverted. The inverted</span>
<span class="sd">    colormap is created by subtracting the red, green, and blue components of each color from 1.0.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        cmap</span>
<span class="sd">            The colormap to invert.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The inverted colormap as a matplotlib.colors.ListedColormap object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">newcolors</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
        <span class="n">newcolors</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">256</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">256</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">256</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">newcolors</span><span class="p">)</span></div>


<div class="viewcode-block" id="reverse_cmap"><a class="viewcode-back" href="../../qmuvi.html#qmuvi.video_generation.reverse_cmap">[docs]</a><span class="k">def</span> <span class="nf">reverse_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Colormap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reverses the order of a Matplotlib colormap.</span>

<span class="sd">    This function takes a Matplotlib colormap object and returns a new colormap with the order of the colors reversed.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        cmap</span>
<span class="sd">            The colormap to reverse.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The reversed colormap as a matplotlib.colors.ListedColormap object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Generate a new set of colors for the reversed colormap using the existing colormap and a linearly spaced array</span>
    <span class="c1"># of values between 0 and 1.</span>
    <span class="n">newcolors</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>

    <span class="c1"># Use a reversed index to select the color at the opposite end of the colormap for each position in the new colormap.</span>
    <span class="n">reversed_i</span> <span class="o">=</span> <span class="mi">255</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
        <span class="c1"># Dividing by 255 instead of 256 so that values include both 0 and 1.</span>
        <span class="n">newcolors</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cmap</span><span class="p">(</span><span class="n">reversed_i</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="p">(</span><span class="n">reversed_i</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cmap</span><span class="p">(</span><span class="n">reversed_i</span> <span class="o">/</span> <span class="mi">255</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">reversed_i</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">newcolors</span><span class="p">)</span></div>


<div class="viewcode-block" id="convert_fig_pixels_to_inches"><a class="viewcode-back" href="../../qmuvi.html#qmuvi.video_generation.convert_fig_pixels_to_inches">[docs]</a><span class="k">def</span> <span class="nf">convert_fig_pixels_to_inches</span><span class="p">(</span><span class="n">pixels</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a size in pixels to inches based on the dpi setting in matplotlib.</span>

<span class="sd">    This function takes a float representing a size in pixels and returns a float representing the equivalent size in</span>
<span class="sd">    inches, based on the current dpi (dots per inch) setting for matplotlib figures.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        pixels</span>
<span class="sd">            The size in pixels to be converted to inches.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The equivalent size in inches.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dpi</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.dpi&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">pixels</span> <span class="o">/</span> <span class="n">dpi</span></div>


<div class="viewcode-block" id="generate_video_from_data"><a class="viewcode-back" href="../../qmuvi.html#qmuvi.video_generation.generate_video_from_data">[docs]</a><span class="k">def</span> <span class="nf">generate_video_from_data</span><span class="p">(</span>
    <span class="n">quantum_circuit</span><span class="p">:</span> <span class="n">qiskit</span><span class="o">.</span><span class="n">QuantumCircuit</span><span class="p">,</span>
    <span class="n">output_manager</span><span class="p">:</span> <span class="n">data_manager</span><span class="o">.</span><span class="n">DataManager</span><span class="p">,</span>
    <span class="n">rhythm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]],</span>
    <span class="n">invert_colours</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">fps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">vpr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">,</span>
    <span class="n">smooth_transitions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">show_measured_probabilities_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Uses generated qMuVi data and wav file to generate a video (.mp4).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        quantum_circuit</span>
<span class="sd">            The qiskit QuantumCircuit.</span>
<span class="sd">        output_manager</span>
<span class="sd">            The data manager to use for saving the video and all of its pieces.</span>
<span class="sd">        rhythm</span>
<span class="sd">            A list of tuples for the length and rest times of each sound in units of ticks (480 ticks is 1 second).</span>
<span class="sd">            If None, then each sound length and rest time will be set to (note_sound, rest_time) = (240, 0)</span>
<span class="sd">        invert_colours</span>
<span class="sd">            Whether to render the video in dark mode.</span>
<span class="sd">        fps</span>
<span class="sd">            The frames per second of the output video.</span>
<span class="sd">        vpr</span>
<span class="sd">            Vertical proportion ratio. The propotion of vertical space that the circuit will occupy. Can be a float or a function that maps qubit_count (int) to float.</span>
<span class="sd">        smooth_transitions</span>
<span class="sd">            Whether to animate the plots by interpolating between qMuVi data samples. Significantly increases render time.</span>
<span class="sd">        show_measured_probabilities_only</span>
<span class="sd">            Whether to only plot the basis state probabilities.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">vpr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">vpr</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vpr</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">vpr_temp</span> <span class="o">=</span> <span class="n">vpr</span>

        <span class="k">def</span> <span class="nf">vpr</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">vpr_temp</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">vpr</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;vpr must be a float, None or a Callable[[int], float]&quot;</span><span class="p">)</span>

    <span class="n">sounds_list</span> <span class="o">=</span> <span class="n">output_manager</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="s2">&quot;sounds_list.json&quot;</span><span class="p">)</span>
    <span class="n">fidelity_list</span> <span class="o">=</span> <span class="n">output_manager</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="s2">&quot;fidelity_list.json&quot;</span><span class="p">)</span>
    <span class="n">measured_probabilities_list</span> <span class="o">=</span> <span class="n">output_manager</span><span class="o">.</span><span class="n">load_json</span><span class="p">(</span><span class="s2">&quot;meas_probs_list.json&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rhythm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rhythm</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sounds_list</span><span class="p">)</span>

    <span class="c1"># format loaded data</span>
    <span class="k">for</span> <span class="n">sound_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sounds_list</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">pure_state_info_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">])):</span>
            <span class="c1"># pure_state_prob: float</span>
            <span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="n">pure_state_info_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="n">pure_state_info_index</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># pure_state_info: Dict[int basis_state_number, Tuple[float basis_state_prob, float basis_state_angle]], # where (basis_state_prob &gt; eps)</span>
            <span class="n">pure_state_info</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">basis_state_number</span> <span class="ow">in</span> <span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="n">pure_state_info_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">pure_state_info</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">basis_state_number</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="n">pure_state_info_index</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">basis_state_number</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="n">pure_state_info_index</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">basis_state_number</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                <span class="p">)</span>
            <span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="n">pure_state_info_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pure_state_info</span>
            <span class="c1"># all_basis_state_probs: List[float basis_state_prob]</span>
            <span class="k">for</span> <span class="n">basis_state_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="n">pure_state_info_index</span><span class="p">][</span><span class="mi">2</span><span class="p">])):</span>
                <span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="n">pure_state_info_index</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">basis_state_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="n">pure_state_info_index</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">basis_state_index</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="c1"># all_basis_state_angles: List[float basis_state_angle]</span>
            <span class="k">for</span> <span class="n">basis_state_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="n">pure_state_info_index</span><span class="p">][</span><span class="mi">3</span><span class="p">])):</span>
                <span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="n">pure_state_info_index</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">basis_state_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="n">pure_state_info_index</span><span class="p">][</span><span class="mi">3</span><span class="p">][</span><span class="n">basis_state_index</span><span class="p">]</span>
                <span class="p">)</span>

    <span class="n">zero_noise</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sounds_list</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sounds_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">zero_noise</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>

    <span class="n">dag</span> <span class="o">=</span> <span class="n">circuit_to_dag</span><span class="p">(</span><span class="n">quantum_circuit</span><span class="p">)</span>
    <span class="n">qubit_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dag</span><span class="o">.</span><span class="n">qubits</span><span class="p">)</span>

    <span class="n">circuit_layers_per_line</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">quantum_circuit</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">output_manager</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;circuit.png&quot;</span><span class="p">),</span> <span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">fold</span><span class="o">=</span><span class="n">circuit_layers_per_line</span><span class="p">)</span>

    <span class="c1"># create partial circuits separated by barrier gates</span>
    <span class="n">partial_circuit_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_circuit</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">qubit_count</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag</span><span class="o">.</span><span class="n">topological_op_nodes</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;barrier&quot;</span><span class="p">:</span>
            <span class="n">partial_circuit_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_circuit</span><span class="p">)</span>
            <span class="n">current_circuit</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">qubit_count</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;measure&quot;</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;barrier&quot;</span><span class="p">:</span>
            <span class="n">current_circuit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">qargs</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">cargs</span><span class="p">)</span>
    <span class="n">partial_circuit_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_circuit</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">partial_circ</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">partial_circuit_list</span><span class="p">):</span>
        <span class="n">partial_circ</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">output_manager</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;partial_circ_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">),</span> <span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># an empty circuit is used to create space in the circuit</span>
    <span class="n">empty_circuit</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">qubit_count</span><span class="p">)</span>
    <span class="n">empty_circuit</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">output_manager</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;partial_circ_empty.png&quot;</span><span class="p">),</span> <span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># a barrier circuit is inserted between partial circuits</span>
    <span class="n">barrier_circuit</span> <span class="o">=</span> <span class="n">QuantumCircuit</span><span class="p">(</span><span class="n">qubit_count</span><span class="p">)</span>
    <span class="n">barrier_circuit</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span>
    <span class="n">barrier_circuit</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">output_manager</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;partial_circ_barrier.png&quot;</span><span class="p">),</span> <span class="n">output</span><span class="o">=</span><span class="s2">&quot;mpl&quot;</span><span class="p">,</span> <span class="n">fold</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Fidelity colour bar</span>
    <span class="n">cmap_fidelity</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="s2">&quot;violet&quot;</span><span class="p">,</span> <span class="s2">&quot;blue&quot;</span><span class="p">])</span>
    <span class="c1"># Musical needle</span>
    <span class="n">cmap_needle</span> <span class="o">=</span> <span class="n">reverse_cmap</span><span class="p">(</span><span class="n">cmap_fidelity</span><span class="p">)</span>
    <span class="c1"># Phase for bar plot bars</span>
    <span class="n">cmap_phase</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s2">&quot;hsv&quot;</span><span class="p">)</span>
    <span class="c1"># Matplotlib plot ticks</span>
    <span class="n">tick_colour</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>

    <span class="n">fidelity_line_colour</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>

    <span class="n">bg_color</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">invert_colours</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">cmap_fidelity</span> <span class="o">=</span> <span class="n">invert_cmap</span><span class="p">(</span><span class="n">cmap_fidelity</span><span class="p">)</span>
        <span class="n">cmap_phase</span> <span class="o">=</span> <span class="n">invert_cmap</span><span class="p">(</span><span class="n">cmap_phase</span><span class="p">)</span>
        <span class="c1"># Note: cmap_needle does not need to be inverted since needle is not part of the image that is inverted</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preparing pieces for video generation...&quot;</span><span class="p">)</span>

    <span class="c1"># format probability and angle data for plotting</span>
    <span class="n">pure_probabilities_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pure_phase_angles_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sound_index</span><span class="p">,</span> <span class="n">sound_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sounds_list</span><span class="p">):</span>
        <span class="c1"># sounds list has tuple elements with the following structure:</span>
        <span class="c1"># (</span>
        <span class="c1">#  pure_state_prob: float,</span>
        <span class="c1">#  pure_state_info: Dict[int basis_state_number, Tuple[float basis_state_prob, float basis_state_angle]], # where (basis_state_prob &gt; eps)</span>
        <span class="c1">#  all_basis_state_probs: List[float basis_state_prob],</span>
        <span class="c1">#  all_basis_state_angles: List[float basis_state_angle]</span>
        <span class="c1"># )</span>
        <span class="n">pure_state_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">])</span>
        <span class="n">pure_probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pure_state_count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">])))</span>
        <span class="n">pure_phase_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pure_state_count</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])))</span>
        <span class="k">for</span> <span class="n">pure_state_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pure_state_count</span><span class="p">):</span>
            <span class="c1"># only plot the pure states that are present in the sound data</span>
            <span class="k">if</span> <span class="n">pure_state_index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sound_data</span><span class="p">):</span>
                <span class="n">pure_probabilities</span><span class="p">[</span><span class="n">pure_state_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="n">pure_state_index</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="n">pure_state_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">pure_phase_angles</span><span class="p">[</span><span class="n">pure_state_index</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">sounds_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="n">pure_state_index</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">pure_probabilities_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pure_probabilities</span><span class="p">)</span>
        <span class="n">pure_phase_angles_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pure_phase_angles</span><span class="p">)</span>

    <span class="n">plot_clips</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">sound_index</span><span class="p">,</span> <span class="n">sound_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sounds_list</span><span class="p">):</span>
        <span class="c1"># plot and save the info panel image</span>
        <span class="n">_plot_info_panel</span><span class="p">(</span>
            <span class="n">output_manager</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="n">pure_probabilities_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">],</span>
            <span class="n">pure_phase_angles_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">],</span>
            <span class="n">fidelity_list</span><span class="p">[</span><span class="n">sound_index</span><span class="p">],</span>
            <span class="n">sound_index</span><span class="p">,</span>
            <span class="n">qubit_count</span><span class="p">,</span>
            <span class="n">cmap_phase</span><span class="p">,</span>
            <span class="n">cmap_fidelity</span><span class="p">,</span>
            <span class="n">tick_colour</span><span class="p">,</span>
            <span class="n">fidelity_line_colour</span><span class="p">,</span>
            <span class="n">invert_colours</span><span class="p">,</span>
            <span class="n">vpr</span><span class="p">,</span>
            <span class="ow">not</span> <span class="n">show_measured_probabilities_only</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># histograms</span>
        <span class="n">target_video_height_pixels</span> <span class="o">=</span> <span class="mi">1080</span>
        <span class="n">dpi</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.dpi&quot;</span><span class="p">]</span>
        <span class="n">target_empty_circuit_height_pixels</span> <span class="o">=</span> <span class="n">target_video_height_pixels</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">vpr</span><span class="p">(</span><span class="n">qubit_count</span><span class="p">))</span>
        <span class="n">fig_height_inches</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">vpr</span><span class="p">(</span><span class="n">qubit_count</span><span class="p">))</span> <span class="o">*</span> <span class="mf">13.5</span>
        <span class="n">fig_height_pixels</span> <span class="o">=</span> <span class="n">fig_height_inches</span> <span class="o">*</span> <span class="n">dpi</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">target_empty_circuit_height_pixels</span> <span class="o">/</span> <span class="n">fig_height_pixels</span>

        <span class="n">scaled_dpi</span> <span class="o">=</span> <span class="n">dpi</span> <span class="o">*</span> <span class="n">scale</span>

        <span class="n">anim_fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">vpr</span><span class="p">(</span><span class="n">qubit_count</span><span class="p">))</span> <span class="o">*</span> <span class="mf">13.5</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">scaled_dpi</span><span class="p">)</span>
        <span class="n">anim_fig</span><span class="o">.</span><span class="n">set_dpi</span><span class="p">(</span><span class="n">scaled_dpi</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">smooth_transitions</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">make_plot_frame</span><span class="p">(</span><span class="n">time_since_frame</span><span class="p">,</span> <span class="n">sound_index_temp</span><span class="o">=</span><span class="n">sound_index</span><span class="p">,</span> <span class="n">anim_fig</span><span class="o">=</span><span class="n">anim_fig</span><span class="p">):</span>
                <span class="n">anim_fig</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

                <span class="n">sound_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">rhythm</span><span class="p">[</span><span class="n">sound_index_temp</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rhythm</span><span class="p">[</span><span class="n">sound_index_temp</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">480.0</span>
                <span class="n">time_between_frames</span> <span class="o">=</span> <span class="n">sound_time</span>

                <span class="c1"># animation interpolation time between frames. Target is 0.10 seconds but will shrink if needed</span>
                <span class="n">transition_time</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="n">transition_time</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">time_between_frames</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)</span>

                <span class="n">transition_scale</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">time_since_frame</span> <span class="o">&gt;=</span> <span class="n">transition_time</span><span class="p">:</span>
                    <span class="n">transition_scale</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">transition_scale</span> <span class="o">=</span> <span class="n">time_since_frame</span> <span class="o">/</span> <span class="n">transition_time</span>

                <span class="k">if</span> <span class="n">sound_index_temp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">interpolated_frame</span> <span class="o">=</span> <span class="n">sound_index_temp</span>
                    <span class="n">interpolate</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">interpolated_frame</span> <span class="o">=</span> <span class="n">sound_index_temp</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">transition_scale</span>
                    <span class="n">interpolate</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="n">anim_fig</span> <span class="o">=</span> <span class="n">_plot_quantum_state</span><span class="p">(</span>
                    <span class="n">anim_fig</span><span class="p">,</span>
                    <span class="n">pure_probabilities_list</span><span class="p">,</span>
                    <span class="n">pure_phase_angles_list</span><span class="p">,</span>
                    <span class="n">measured_probabilities_list</span><span class="p">,</span>
                    <span class="n">interpolated_frame</span><span class="p">,</span>
                    <span class="n">qubit_count</span><span class="p">,</span>
                    <span class="n">interpolate</span><span class="p">,</span>
                    <span class="n">cmap_phase</span><span class="p">,</span>
                    <span class="n">tick_colour</span><span class="p">,</span>
                    <span class="n">vpr</span><span class="p">,</span>
                    <span class="n">zero_noise</span><span class="p">,</span>
                    <span class="n">show_measured_probabilities_only</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">mplfig_to_npimage</span><span class="p">(</span><span class="n">anim_fig</span><span class="p">)</span>

            <span class="n">plot_clips</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">VideoClip</span><span class="p">(</span><span class="n">make_plot_frame</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">rhythm</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rhythm</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">480</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">anim_fig</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

            <span class="n">anim_fig</span> <span class="o">=</span> <span class="n">_plot_quantum_state</span><span class="p">(</span>
                <span class="n">anim_fig</span><span class="p">,</span>
                <span class="n">pure_probabilities_list</span><span class="p">,</span>
                <span class="n">pure_phase_angles_list</span><span class="p">,</span>
                <span class="n">measured_probabilities_list</span><span class="p">,</span>
                <span class="n">sound_index</span><span class="p">,</span>
                <span class="n">qubit_count</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">cmap_phase</span><span class="p">,</span>
                <span class="n">tick_colour</span><span class="p">,</span>
                <span class="n">vpr</span><span class="p">,</span>
                <span class="n">zero_noise</span><span class="p">,</span>
                <span class="n">show_measured_probabilities_only</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">frame_image</span> <span class="o">=</span> <span class="n">mplfig_to_npimage</span><span class="p">(</span><span class="n">anim_fig</span><span class="p">)</span>
            <span class="n">plot_clips</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ImageClip</span><span class="p">(</span><span class="n">frame_image</span><span class="p">)</span><span class="o">.</span><span class="n">set_duration</span><span class="p">((</span><span class="n">rhythm</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rhythm</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">480</span><span class="p">))</span>

    <span class="c1"># calculate the accumulated time for each sampled state in the animation from the rhythm</span>
    <span class="n">accumulated_times</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">accumulated_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">accumulated_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">times</span> <span class="ow">in</span> <span class="n">rhythm</span><span class="p">:</span>
        <span class="n">sound_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">times</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">480.0</span>
        <span class="n">accumulated_time</span> <span class="o">+=</span> <span class="n">sound_time</span>
        <span class="n">accumulated_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accumulated_time</span><span class="p">)</span>

    <span class="n">paths</span> <span class="o">=</span> <span class="n">output_manager</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;info_panel_*&quot;</span><span class="p">)</span>

    <span class="c1"># sort in ascending order of frame number in filename, e.g. info_panel_0, info_panel_1, ...</span>
    <span class="n">paths</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">data_manager</span><span class="o">.</span><span class="n">extract_natural_number_from_string_end</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># create info panel clips and stack them to the right of the plot clips</span>
    <span class="k">for</span> <span class="n">file_index</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
        <span class="n">frame_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">rhythm</span><span class="p">[</span><span class="n">file_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rhythm</span><span class="p">[</span><span class="n">file_index</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">480.0</span>
        <span class="n">info_panel_clip</span> <span class="o">=</span> <span class="n">ImageClip</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">set_duration</span><span class="p">(</span><span class="n">frame_time</span><span class="p">)</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">plot_clips</span><span class="p">[</span><span class="n">file_index</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">info_panel_width</span> <span class="o">=</span> <span class="n">info_panel_clip</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">plot_clips</span><span class="p">[</span><span class="n">file_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">clips_array</span><span class="p">([[</span><span class="n">plot_clips</span><span class="p">[</span><span class="n">file_index</span><span class="p">],</span> <span class="n">info_panel_clip</span><span class="p">]],</span> <span class="n">bg_color</span><span class="o">=</span><span class="n">bg_color</span><span class="p">)</span>

    <span class="n">plot_info_clip</span> <span class="o">=</span> <span class="n">concatenate</span><span class="p">(</span><span class="n">plot_clips</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;compose&quot;</span><span class="p">)</span>

    <span class="c1"># for target height 1080 pixels, the plot_info_clip should now be 1920 x 720 pixels</span>
    <span class="k">if</span> <span class="n">invert_colours</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">plot_info_clip</span> <span class="o">=</span> <span class="n">invert_colors</span><span class="o">.</span><span class="n">invert_colors</span><span class="p">(</span><span class="n">plot_info_clip</span><span class="p">)</span>

    <span class="n">video_duration</span> <span class="o">=</span> <span class="n">plot_info_clip</span><span class="o">.</span><span class="n">duration</span>
    <span class="n">plot_info_clip_height</span> <span class="o">=</span> <span class="n">plot_info_clip</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">circuit_anim_height</span> <span class="o">=</span> <span class="mi">1080</span> <span class="o">-</span> <span class="n">plot_info_clip_height</span>

    <span class="n">image_barrier_clip_base</span> <span class="o">=</span> <span class="n">ImageClip</span><span class="p">(</span><span class="n">output_manager</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;partial_circ_barrier.png&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">set_duration</span><span class="p">(</span><span class="n">video_duration</span><span class="p">)</span>

    <span class="c1"># crop the horizontal white space from the sides of the barrier image</span>
    <span class="k">if</span> <span class="n">image_barrier_clip_base</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">156</span><span class="p">:</span>
        <span class="n">image_barrier_clip_base</span> <span class="o">=</span> <span class="n">crop</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">image_barrier_clip_base</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="mi">133</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="n">image_barrier_clip_base</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">23</span><span class="p">)</span>
    <span class="n">image_barrier_clip_base</span> <span class="o">=</span> <span class="n">image_barrier_clip_base</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">circuit_anim_height</span><span class="p">)</span>

    <span class="n">barrier_image_width</span> <span class="o">=</span> <span class="n">image_barrier_clip_base</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">barrier_image_height</span> <span class="o">=</span> <span class="n">image_barrier_clip_base</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">barrier_start_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">43.0</span> <span class="o">*</span> <span class="n">barrier_image_height</span> <span class="o">/</span> <span class="mf">454.0</span><span class="p">)</span>
    <span class="n">barrier_end_y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">25.0</span> <span class="o">*</span> <span class="n">barrier_image_height</span> <span class="o">/</span> <span class="mf">454.0</span><span class="p">)</span>

    <span class="n">image_empty_clip</span> <span class="o">=</span> <span class="n">ImageClip</span><span class="p">(</span><span class="n">output_manager</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">&quot;partial_circ_empty.png&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">set_duration</span><span class="p">(</span><span class="n">video_duration</span><span class="p">)</span>

    <span class="c1"># crop the horizontal white space from the sides of the empty circuit image</span>
    <span class="k">if</span> <span class="n">image_empty_clip</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">156</span><span class="p">:</span>
        <span class="n">image_empty_clip</span> <span class="o">=</span> <span class="n">crop</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">image_empty_clip</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="mi">133</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="n">image_empty_clip</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">23</span><span class="p">)</span>
    <span class="n">image_empty_clip</span> <span class="o">=</span> <span class="n">image_empty_clip</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">circuit_anim_height</span><span class="p">)</span>

    <span class="n">duplicate_count</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">barrier_image_width</span><span class="p">)</span> <span class="o">/</span> <span class="n">image_empty_clip</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">image_empty_clip_array</span> <span class="o">=</span> <span class="n">clips_array</span><span class="p">([[</span><span class="n">image_empty_clip</span><span class="p">]</span> <span class="o">*</span> <span class="n">duplicate_count</span><span class="p">],</span> <span class="n">bg_color</span><span class="o">=</span><span class="n">bg_color</span><span class="p">)</span>
    <span class="n">image_empty_clip_array</span> <span class="o">=</span> <span class="n">crop</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">image_empty_clip_array</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="n">barrier_image_width</span><span class="p">)</span>

    <span class="n">partial_circuit_clip_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">positions_x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">accumulated_width</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">partial_circ</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">partial_circuit_list</span><span class="p">):</span>
        <span class="n">partial_circuit_clip</span> <span class="o">=</span> <span class="n">ImageClip</span><span class="p">(</span><span class="n">output_manager</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;partial_circ_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">set_duration</span><span class="p">(</span><span class="n">video_duration</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">partial_circuit_clip</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">156</span><span class="p">:</span>
            <span class="n">partial_circuit_clip</span> <span class="o">=</span> <span class="n">crop</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span><span class="n">partial_circuit_clip</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="mi">133</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="n">partial_circuit_clip</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">23</span><span class="p">)</span>
        <span class="n">partial_circuit_clip</span> <span class="o">=</span> <span class="n">partial_circuit_clip</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">circuit_anim_height</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">partial_circuit_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">accumulated_width</span> <span class="o">+=</span> <span class="n">partial_circuit_clip</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">barrier_image_width</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">accumulated_width</span> <span class="o">+=</span> <span class="n">partial_circuit_clip</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">positions_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">accumulated_width</span><span class="p">)</span>
        <span class="n">partial_circuit_clip_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">partial_circuit_clip</span><span class="p">)</span>

    <span class="n">all_circuit_clip_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">partial_circuit_clip_list</span><span class="p">)):</span>
        <span class="n">all_circuit_clip_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">partial_circuit_clip_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">partial_circuit_clip_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">all_circuit_clip_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image_empty_clip_array</span><span class="p">)</span>

    <span class="n">full_circuit_clip</span> <span class="o">=</span> <span class="n">clips_array</span><span class="p">([[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_circuit_clip_list</span><span class="p">]],</span> <span class="n">bg_color</span><span class="o">=</span><span class="n">bg_color</span><span class="p">)</span>

    <span class="n">full_circuit_clip</span><span class="o">.</span><span class="n">fps</span> <span class="o">=</span> <span class="n">fps</span>
    <span class="n">full_circuit_and_barrier_clips_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">full_circuit_and_barrier_clips_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_circuit_clip</span><span class="p">)</span>

    <span class="n">accumulated_time_info</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># tuple: (accumulated_time, note_length, note_rest). Used in drawing of needle</span>
    <span class="n">accumulated_time</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">sound_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rhythm</span><span class="p">)):</span>
        <span class="n">note_length</span> <span class="o">=</span> <span class="n">rhythm</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">480.0</span>
        <span class="n">note_rest</span> <span class="o">=</span> <span class="n">rhythm</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">480.0</span>
        <span class="n">barrier_clip</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">image_barrier_clip_base</span><span class="o">.</span><span class="n">set_start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="o">.</span><span class="n">set_end</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">accumulated_time</span><span class="p">,</span> <span class="n">video_duration</span><span class="p">))</span>
            <span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">positions_x</span><span class="p">[</span><span class="n">sound_index</span><span class="p">]</span> <span class="o">-</span> <span class="n">barrier_image_width</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">accumulated_time_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">accumulated_time</span><span class="p">,</span> <span class="n">note_length</span><span class="p">,</span> <span class="n">note_rest</span><span class="p">))</span>
        <span class="n">accumulated_time</span> <span class="o">+=</span> <span class="n">note_length</span> <span class="o">+</span> <span class="n">note_rest</span>
        <span class="n">full_circuit_and_barrier_clips_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">barrier_clip</span><span class="p">)</span>

    <span class="n">full_circuit_with_barriers_clip</span> <span class="o">=</span> <span class="n">CompositeVideoClip</span><span class="p">(</span><span class="n">full_circuit_and_barrier_clips_list</span><span class="p">)</span>

    <span class="n">output_width</span> <span class="o">=</span> <span class="mi">1920</span>

    <span class="c1"># add margins so that the circuit can slide over the rendered output (I don&#39;t think it&#39;s necessary)</span>
    <span class="n">full_circuit_with_barriers_clip</span> <span class="o">=</span> <span class="n">full_circuit_with_barriers_clip</span><span class="o">.</span><span class="n">margin</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">output_width</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">output_width</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">bg_color</span><span class="p">)</span>

    <span class="c1"># TODO: change pan effect so that position is changed similar to</span>
    <span class="c1"># clip.set_position(lambda t: (&#39;center&#39;, 50+t) ) https://zulko.github.io/moviepy/getting_started/compositing.html</span>
    <span class="c1"># This is so that the full extended margin video above doesn&#39;t needs to be rendered and a time and frame effect doesn&#39;t need to be applied, which can be slow.</span>
    <span class="k">def</span> <span class="nf">circuit_clip_animate_pan_effect</span><span class="p">(</span><span class="n">gf</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">t</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Animates the circuit clip panning to the rhythm.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            gf</span>
<span class="sd">                the clips get_frame method that returns the frame of the clip at time t.</span>
<span class="sd">            t</span>
<span class="sd">                the time in seconds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            the frame of the clip at time t.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_start</span> <span class="o">=</span> <span class="n">output_width</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">next_accumulated_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prev_accumulated_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">frame_sound_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rhythm</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">sound_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rhythm</span><span class="p">)):</span>
            <span class="n">prev_accumulated_time</span> <span class="o">=</span> <span class="n">next_accumulated_time</span>
            <span class="n">next_accumulated_time</span> <span class="o">+=</span> <span class="p">(</span><span class="n">rhythm</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">rhythm</span><span class="p">[</span><span class="n">sound_index</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">480.0</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">next_accumulated_time</span><span class="p">:</span>
                <span class="n">frame_sound_index</span> <span class="o">=</span> <span class="n">sound_index</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">frame_sound_index</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rhythm</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">next_pos</span> <span class="o">=</span> <span class="n">positions_x</span><span class="p">[</span><span class="n">frame_sound_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">barrier_image_width</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">next_pos</span> <span class="o">=</span> <span class="n">positions_x</span><span class="p">[</span><span class="n">frame_sound_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">prev_pos</span> <span class="o">=</span> <span class="n">positions_x</span><span class="p">[</span><span class="n">frame_sound_index</span><span class="p">]</span> <span class="o">-</span> <span class="n">barrier_image_width</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">prev_pos</span> <span class="o">+</span> <span class="p">(</span><span class="n">next_pos</span> <span class="o">-</span> <span class="n">prev_pos</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">prev_accumulated_time</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">next_accumulated_time</span> <span class="o">-</span> <span class="n">prev_accumulated_time</span><span class="p">)))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">gf</span><span class="p">(</span><span class="n">t</span><span class="p">)[</span><span class="n">y</span> <span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">circuit_anim_height</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">output_width</span><span class="p">]</span>

    <span class="n">full_circuit_animated_clip</span> <span class="o">=</span> <span class="n">full_circuit_with_barriers_clip</span><span class="o">.</span><span class="n">fl</span><span class="p">(</span><span class="n">circuit_clip_animate_pan_effect</span><span class="p">,</span> <span class="n">apply_to</span><span class="o">=</span><span class="s2">&quot;mask&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">invert_colours</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">full_circuit_animated_clip</span> <span class="o">=</span> <span class="n">invert_colors</span><span class="o">.</span><span class="n">invert_colors</span><span class="p">(</span><span class="n">full_circuit_animated_clip</span><span class="p">)</span>

    <span class="n">complete_clip</span> <span class="o">=</span> <span class="n">clips_array</span><span class="p">([[</span><span class="n">full_circuit_animated_clip</span><span class="p">],</span> <span class="p">[</span><span class="n">plot_info_clip</span><span class="p">]],</span> <span class="n">bg_color</span><span class="o">=</span><span class="n">bg_color</span><span class="p">)</span>

    <span class="n">video_final_silent</span> <span class="o">=</span> <span class="n">crop</span><span class="o">.</span><span class="n">crop</span><span class="p">(</span>
        <span class="n">complete_clip</span><span class="p">,</span> <span class="n">x1</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">complete_clip</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">output_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">x2</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">complete_clip</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">output_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># add audio</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="n">output_manager</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_manager</span><span class="o">.</span><span class="n">default_name</span><span class="si">}</span><span class="s2">-*.wav&quot;</span><span class="p">)</span>
    <span class="n">audio_file_clips</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
        <span class="n">path_multiplatform</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">audio_file_clip</span> <span class="o">=</span> <span class="n">mpy</span><span class="o">.</span><span class="n">AudioFileClip</span><span class="p">(</span><span class="n">path_multiplatform</span><span class="p">,</span> <span class="n">nbytes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">44100</span><span class="p">)</span>
        <span class="n">audio_file_clips</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">audio_file_clip</span><span class="p">)</span>
    <span class="n">composed_audio_clip</span> <span class="o">=</span> <span class="n">CompositeAudioClip</span><span class="p">(</span><span class="n">audio_file_clips</span><span class="p">)</span>

    <span class="n">video_final</span> <span class="o">=</span> <span class="n">video_final_silent</span><span class="o">.</span><span class="n">set_audio</span><span class="p">(</span><span class="n">composed_audio_clip</span><span class="p">)</span>

    <span class="n">video_final_width</span> <span class="o">=</span> <span class="n">video_final</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">draw_needle_effect</span><span class="p">(</span><span class="n">get_frame</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Draw a rectangle in the frame on top of the circuit animated clip.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            get_frame</span>
<span class="sd">                the clips get_frame method that returns the frame of the clip at time t.</span>
<span class="sd">            t</span>
<span class="sd">                the time in seconds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            the frame of the clip at time t.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># change (top, bottom, left, right) to the coordinates</span>
        <span class="n">top</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># make the gap between the bottom and the barrier the same as the gap between the top and the barrier.</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">full_circuit_animated_clip</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">barrier_start_y</span> <span class="o">-</span> <span class="n">barrier_end_y</span><span class="p">))</span>
        <span class="n">left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">video_final_width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">9</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">video_final_width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">9</span><span class="p">)</span>
        <span class="c1"># get accumulated time, sound times and fidelity for the current frame</span>
        <span class="n">current_time_info</span> <span class="o">=</span> <span class="n">accumulated_time_info</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">fidelity</span> <span class="o">=</span> <span class="n">fidelity_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">sound_index</span><span class="p">,</span> <span class="n">sound_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">accumulated_time_info</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sound_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">t</span><span class="p">:</span>
                <span class="n">current_time_info</span> <span class="o">=</span> <span class="n">accumulated_time_info</span><span class="p">[</span><span class="n">sound_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">fidelity</span> <span class="o">=</span> <span class="n">fidelity_list</span><span class="p">[</span><span class="n">sound_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">break</span>

        <span class="n">time_since_sound_played</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="n">current_time_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">highlight_fade_time</span> <span class="o">=</span> <span class="n">current_time_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">idle_colour</span> <span class="o">=</span> <span class="p">[</span><span class="mi">127</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">127</span><span class="p">]</span>
        <span class="n">lerp_time</span> <span class="o">=</span> <span class="n">time_since_sound_played</span> <span class="o">/</span> <span class="n">highlight_fade_time</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">fidelity</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span>  <span class="c1"># fidelity from [0, 1] to scale [1, -1]</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">scale</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">highlight_colour</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">cmap_needle</span><span class="p">(</span><span class="n">scale</span><span class="p">)[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
        <span class="n">lerp_colour</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ease_out</span><span class="p">(</span><span class="n">highlight_colour</span><span class="p">,</span> <span class="n">idle_colour</span><span class="p">,</span> <span class="n">lerp_time</span><span class="p">)]</span>

        <span class="n">frame</span> <span class="o">=</span> <span class="n">get_frame</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">frame</span><span class="p">[</span><span class="n">top</span> <span class="p">:</span> <span class="n">top</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">]</span> <span class="o">=</span> <span class="n">lerp_colour</span>
        <span class="n">frame</span><span class="p">[</span><span class="n">bottom</span> <span class="o">-</span> <span class="mi">3</span> <span class="p">:</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span><span class="n">right</span><span class="p">]</span> <span class="o">=</span> <span class="n">lerp_colour</span>
        <span class="n">frame</span><span class="p">[</span><span class="n">top</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">:</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">left</span> <span class="p">:</span> <span class="n">left</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">lerp_colour</span>
        <span class="n">frame</span><span class="p">[</span><span class="n">top</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">:</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">right</span> <span class="o">-</span> <span class="mi">3</span> <span class="p">:</span> <span class="n">right</span><span class="p">]</span> <span class="o">=</span> <span class="n">lerp_colour</span>

        <span class="k">return</span> <span class="n">frame</span>

    <span class="n">video_final</span> <span class="o">=</span> <span class="n">video_final</span><span class="o">.</span><span class="n">fl</span><span class="p">(</span><span class="n">draw_needle_effect</span><span class="p">)</span>

    <span class="n">script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>

    <span class="n">asset_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="s2">&quot;package_data&quot;</span><span class="p">,</span> <span class="s2">&quot;assets&quot;</span><span class="p">)</span>

    <span class="c1"># add the &quot;Video generated by qMuVi&quot; text.</span>
    <span class="k">if</span> <span class="n">invert_colours</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">generated_title_img</span> <span class="o">=</span> <span class="s2">&quot;white.png&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">generated_title_img</span> <span class="o">=</span> <span class="s2">&quot;black.png&quot;</span>

    <span class="n">generated_title_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">info_panel_width</span> <span class="o">*</span> <span class="mf">0.87</span><span class="p">)</span>
    <span class="n">generated_title_hor_padding</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">info_panel_width</span> <span class="o">-</span> <span class="n">generated_title_width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>

    <span class="n">generated_title</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ImageClip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">asset_path</span><span class="p">,</span> <span class="n">generated_title_img</span><span class="p">))</span>
        <span class="o">.</span><span class="n">set_duration</span><span class="p">(</span><span class="n">video_final</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
        <span class="o">.</span><span class="n">set_pos</span><span class="p">((</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">))</span>
        <span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">generated_title_width</span><span class="p">)</span>
        <span class="o">.</span><span class="n">margin</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="n">generated_title_hor_padding</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">video_final</span> <span class="o">=</span> <span class="n">CompositeVideoClip</span><span class="p">([</span><span class="n">video_final</span><span class="p">,</span> <span class="n">generated_title</span><span class="p">])</span>

    <span class="c1"># uncomment to output a frame so be able to check the output without needing to wait for the full video to render.</span>
    <span class="c1"># video_final.save_frame(output_manager.get_default_file_pathname() + &quot;_frame.png&quot;, t=0.1)</span>

    <span class="c1"># preset options (speed vs filesize): ultrafast, superfast, veryfast, faster, fast, medium, slow, slower, veryslow, placebo</span>
    <span class="n">video_final</span><span class="o">.</span><span class="n">write_videofile</span><span class="p">(</span>
        <span class="n">output_manager</span><span class="o">.</span><span class="n">get_default_file_pathname</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.mp4&quot;</span><span class="p">,</span>
        <span class="n">preset</span><span class="o">=</span><span class="s2">&quot;ultrafast&quot;</span><span class="p">,</span>
        <span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span>
        <span class="n">codec</span><span class="o">=</span><span class="s2">&quot;mpeg4&quot;</span><span class="p">,</span>
        <span class="n">audio_fps</span><span class="o">=</span><span class="mi">44100</span><span class="p">,</span>
        <span class="n">audio_codec</span><span class="o">=</span><span class="s2">&quot;libmp3lame&quot;</span><span class="p">,</span>
        <span class="n">audio_bitrate</span><span class="o">=</span><span class="s2">&quot;3000k&quot;</span><span class="p">,</span>
        <span class="n">audio_nbytes</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">ffmpeg_params</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;-b:v&quot;</span><span class="p">,</span> <span class="s2">&quot;12000K&quot;</span><span class="p">,</span> <span class="s2">&quot;-b:a&quot;</span><span class="p">,</span> <span class="s2">&quot;3000k&quot;</span><span class="p">],</span>
    <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_plot_phase_wheel</span><span class="p">(</span>
    <span class="n">fig</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span>
    <span class="n">probabilities</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">phase_angles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="n">cmap_phase</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Colormap</span><span class="p">,</span>
    <span class="n">tick_colour</span><span class="p">:</span> <span class="n">Colour</span><span class="p">,</span>
    <span class="n">invert_colours</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots a phase wheel with line indicators on it for the given phase_angles and returns a dictionary of the axes.</span>

<span class="sd">    This method plots a phase wheel with line indicators on it for the given phase_angles. The phase wheel is a polar</span>
<span class="sd">    plot with the total probability of each phase as the radial axis and the phase angle as the angular axis. The line</span>
<span class="sd">    indicators are plotted as a series of lines that extend from the centre of the plot to the outer edge of the plot</span>
<span class="sd">    at the given phase angle. The line indicators are coloured according to the angle of the phase.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        fig</span>
<span class="sd">            a matplotlib figure object.</span>
<span class="sd">        probabilities</span>
<span class="sd">            a list of floats representing the probability of basis state.</span>
<span class="sd">        phase_angles</span>
<span class="sd">            a list of floats representing the phase angle of basis state.</span>
<span class="sd">        cmap_phase</span>
<span class="sd">            a matplotlib colormap object representing the colour map to use for the phase wheel.</span>
<span class="sd">        tick_colour</span>
<span class="sd">            the colour of the tick labels.</span>
<span class="sd">        invert_colours</span>
<span class="sd">            whether to invert the colours of the phase wheel.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        A dictionary mapping the labels to the matplotlib Axes objects generated for the phase wheel. The order of</span>
<span class="sd">        the axes is left-to-right and top-to-bottom of their position in the total layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fig_gridspec_phase_wheel</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="mf">0.12</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="mf">0.44</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="mf">0.93</span><span class="p">,</span> <span class="s2">&quot;wspace&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;hspace&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;height_ratios&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
    <span class="n">plot_mosaic_phase_wheel_dict</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;phase_wheel&quot;</span><span class="p">],</span>
        <span class="p">],</span>
        <span class="n">gridspec_kw</span><span class="o">=</span><span class="n">fig_gridspec_phase_wheel</span><span class="p">,</span>
        <span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="s2">&quot;polar&quot;</span><span class="p">},</span>
    <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">plot_mosaic_phase_wheel_dict</span><span class="p">[</span><span class="s2">&quot;phase_wheel&quot;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="n">azimuths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">361</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">azimuths</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">30</span><span class="p">,</span> <span class="mi">361</span><span class="p">))</span>
    <span class="n">azimuths</span> <span class="o">=</span> <span class="n">azimuths</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span>
    <span class="n">zeniths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">plot_mosaic_phase_wheel_dict</span><span class="p">[</span><span class="s2">&quot;phase_wheel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">azimuths</span><span class="p">,</span> <span class="n">zeniths</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_phase</span><span class="p">)</span>
    <span class="n">plot_mosaic_phase_wheel_dict</span><span class="p">[</span><span class="s2">&quot;phase_wheel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">azimuths</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#FFFFFF&quot;</span><span class="p">)</span>

    <span class="n">plot_mosaic_phase_wheel_dict</span><span class="p">[</span><span class="s2">&quot;phase_wheel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">azimuths</span><span class="p">,</span> <span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">*</span> <span class="mi">361</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">tick_colour</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Plot the phase angle indicators.</span>
    <span class="c1"># Need to bin the angles to determine the total probability of each bin, then plot the lines with the correct length.</span>
    <span class="n">angle_bin_count</span> <span class="o">=</span> <span class="mi">180</span>
    <span class="n">angles_bin</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">angle_bin_count</span><span class="p">))</span>
    <span class="n">phase_angle_probabilities</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="n">angles_bin</span><span class="p">:</span>
        <span class="n">phase_angle_probabilities</span><span class="p">[</span><span class="n">angle</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">angle_iter</span><span class="p">,</span> <span class="n">phase_angle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phase_angles</span><span class="p">):</span>
            <span class="n">converted_angle</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">angle_bin_count</span> <span class="o">*</span> <span class="p">(</span><span class="n">phase_angle</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span> <span class="o">%</span> <span class="n">angle_bin_count</span>
            <span class="k">if</span> <span class="n">angle</span> <span class="o">==</span> <span class="n">converted_angle</span><span class="p">:</span>
                <span class="n">phase_angle_probabilities</span><span class="p">[</span><span class="n">angle</span><span class="p">]</span> <span class="o">+=</span> <span class="n">probabilities</span><span class="p">[</span><span class="n">angle_iter</span><span class="p">]</span>

    <span class="n">highest_probability</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">phase_angle_probabilities</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">angle_iter</span><span class="p">,</span> <span class="n">phase_angle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phase_angles</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">probabilities</span><span class="p">[</span><span class="n">angle_iter</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">:</span>
            <span class="n">colour_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">phase_angle</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
            <span class="n">converted_angle</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">angle_bin_count</span> <span class="o">*</span> <span class="p">(</span><span class="n">phase_angle</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span> <span class="o">%</span> <span class="n">angle_bin_count</span>
            <span class="n">length</span> <span class="o">=</span> <span class="n">phase_angle_probabilities</span><span class="p">[</span><span class="n">converted_angle</span><span class="p">]</span> <span class="o">/</span> <span class="n">highest_probability</span>
            <span class="n">plot_mosaic_phase_wheel_dict</span><span class="p">[</span><span class="s2">&quot;phase_wheel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">phase_angle</span><span class="p">]</span> <span class="o">*</span> <span class="mi">40</span><span class="p">,</span> <span class="n">length</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="n">cmap_phase</span><span class="p">(</span><span class="n">colour_value</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">invert_colours</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">plot_mosaic_phase_wheel_dict</span><span class="p">[</span><span class="s2">&quot;phase_wheel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;polar&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">tick_colour</span><span class="p">)</span>

    <span class="n">plot_mosaic_phase_wheel_dict</span><span class="p">[</span><span class="s2">&quot;phase_wheel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">plot_mosaic_phase_wheel_dict</span><span class="p">[</span><span class="s2">&quot;phase_wheel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">tick_colour</span><span class="p">)</span>
    <span class="n">plot_mosaic_phase_wheel_dict</span><span class="p">[</span><span class="s2">&quot;phase_wheel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">tick_colour</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.82</span><span class="p">,</span> <span class="mf">0.465</span><span class="p">,</span> <span class="s2">&quot;Phase&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="n">label_positions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\frac{\pi}</span><span class="si">{2}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\pi$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\frac{3\pi}</span><span class="si">{2}</span><span class="s2">$&quot;</span><span class="p">]</span>
    <span class="n">plot_mosaic_phase_wheel_dict</span><span class="p">[</span><span class="s2">&quot;phase_wheel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">label_positions</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
    <span class="n">plot_mosaic_phase_wheel_dict</span><span class="p">[</span><span class="s2">&quot;phase_wheel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">plot_mosaic_phase_wheel_dict</span>


<span class="k">def</span> <span class="nf">_plot_stat_bars</span><span class="p">(</span>
    <span class="n">fig</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span>
    <span class="n">fidelity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">cmap_fidelity</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Colormap</span><span class="p">,</span>
    <span class="n">c_gray</span><span class="p">:</span> <span class="n">Colour</span><span class="p">,</span>
    <span class="n">tick_colour</span><span class="p">:</span> <span class="n">Colour</span><span class="p">,</span>
    <span class="n">invert_colours</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots a fidelity bar and returns a dictionary of the axes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        fig</span>
<span class="sd">            The figure to add the bar to.</span>
<span class="sd">        fidelity</span>
<span class="sd">            The fidelity value to plot.</span>
<span class="sd">        cmap_fidelity</span>
<span class="sd">            The colormap to use for the fidelity bar.</span>
<span class="sd">        c_gray</span>
<span class="sd">            The color of the fidelity line.</span>
<span class="sd">        tick_colour</span>
<span class="sd">            The color of the ticks.</span>
<span class="sd">        invert_colours</span>
<span class="sd">            Whether or not to invert the colors of the plot.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        A dictionary mapping the labels to the matplotlib Axes objects generated for the fidelity bar. The order of</span>
<span class="sd">        the axes is left-to-right and top-to-bottom of their position in the total layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fig_gridspec_stat_bars</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.95</span> <span class="o">-</span> <span class="mf">0.08</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.08</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span>
        <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="mf">0.93</span><span class="p">,</span>
        <span class="s2">&quot;wspace&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;hspace&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;height_ratios&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="p">}</span>
    <span class="n">plot_mosaic_stat_bars_dict</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span>
        <span class="p">[[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]],</span>
        <span class="n">gridspec_kw</span><span class="o">=</span><span class="n">fig_gridspec_stat_bars</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">plot_mosaic_stat_bars_dict</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="n">plot_mosaic_stat_bars_dict</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">([[</span><span class="n">val</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">))]))),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_fidelity</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;bicubic&quot;</span>
    <span class="p">)</span>

    <span class="n">line_y</span> <span class="o">=</span> <span class="n">fig_gridspec_stat_bars</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">fig_gridspec_stat_bars</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fig_gridspec_stat_bars</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">fidelity</span>
    <span class="n">line_middle_x</span> <span class="o">=</span> <span class="n">fig_gridspec_stat_bars</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">fig_gridspec_stat_bars</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fig_gridspec_stat_bars</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="n">line_middle_x</span> <span class="o">-</span> <span class="mf">0.035</span><span class="p">,</span> <span class="n">line_middle_x</span> <span class="o">+</span> <span class="mf">0.035</span><span class="p">],</span> <span class="p">[</span><span class="n">line_y</span><span class="p">,</span> <span class="n">line_y</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_gray</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">line</span><span class="o">.</span><span class="n">set_clip_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">plot_mosaic_stat_bars_dict</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">tick_colour</span><span class="p">)</span>
    <span class="n">plot_mosaic_stat_bars_dict</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">tick_colour</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">invert_colours</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">plot_mosaic_stat_bars_dict</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">tick_colour</span><span class="p">)</span>
        <span class="n">plot_mosaic_stat_bars_dict</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">tick_colour</span><span class="p">)</span>
        <span class="n">plot_mosaic_stat_bars_dict</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">tick_colour</span><span class="p">)</span>
        <span class="n">plot_mosaic_stat_bars_dict</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">tick_colour</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">plot_mosaic_stat_bars_dict</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_ticklines</span><span class="p">():</span>
            <span class="n">t</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">tick_colour</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">plot_mosaic_stat_bars_dict</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_ticklines</span><span class="p">():</span>
            <span class="n">t</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">tick_colour</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.82</span><span class="p">,</span> <span class="mf">0.945</span><span class="p">,</span> <span class="s2">&quot;Fidelity&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.82</span><span class="p">,</span> <span class="mf">0.905</span><span class="p">,</span> <span class="nb">format</span><span class="p">(</span><span class="n">fidelity</span><span class="p">,</span> <span class="s2">&quot;.2f&quot;</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="n">plot_mosaic_stat_bars_dict</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">plot_mosaic_stat_bars_dict</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">99</span><span class="p">))</span>
    <span class="n">y_tick_positions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">99</span><span class="p">]</span>
    <span class="n">y_tick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
    <span class="n">plot_mosaic_stat_bars_dict</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">y_tick_positions</span><span class="p">)</span>
    <span class="n">plot_mosaic_stat_bars_dict</span><span class="p">[</span><span class="s2">&quot;fidelity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">y_tick_labels</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">plot_mosaic_stat_bars_dict</span>


<span class="k">def</span> <span class="nf">_plot_quantum_state</span><span class="p">(</span>
    <span class="n">fig</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">],</span>
    <span class="n">pure_probabilities_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">pure_phase_angles_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">measured_probabilities_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">sampled_state_number</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
    <span class="n">qubit_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">interpolate</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">cmap_phase</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Colormap</span><span class="p">,</span>
    <span class="n">tick_colour</span><span class="p">:</span> <span class="n">Colour</span><span class="p">,</span>
    <span class="n">vpr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]],</span>
    <span class="n">zero_noise</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">show_measured_probabilities_only</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plots the quantum state for given probability and phase distributions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        fig</span>
<span class="sd">            The figure to plot the quantum state on. If None, a new figure is created.</span>
<span class="sd">        pure_probabilities_list</span>
<span class="sd">            A list containing a 2d array for each sampled state, where the array contains probabilities indexed by pure state number and basis state number.</span>
<span class="sd">        pure_phase_angles_list</span>
<span class="sd">            A list containing a 2d array for each sampled state, where the array contains phase angles indexed by pure state number and basis state number.</span>
<span class="sd">        measured_probabilities_list</span>
<span class="sd">            A list containing a 1d array for each sampled state, where the array contains measurement probabilities indexed by basis state number.</span>
<span class="sd">        sampled_state_number</span>
<span class="sd">            The index of the sampled state to be plotted. If interpolate is True, then this can be a decimal fraction.</span>
<span class="sd">        qubit_count</span>
<span class="sd">            The number of qubits in the quantum state.</span>
<span class="sd">        interpolate</span>
<span class="sd">            Whether to interpolate `sampled_state_number`.</span>
<span class="sd">        cmap_phase</span>
<span class="sd">            A colourmap for the phase angle colours in the phase wheel. The colourmap should map normalised phase angles [0,1] to colours.</span>
<span class="sd">        tick_colour</span>
<span class="sd">            The color of the tick marks.</span>
<span class="sd">        vpr</span>
<span class="sd">            Propotion of vertical space that the circuit will occupy. Can be a float or a function that maps qubit_count (int) to float.</span>
<span class="sd">        zero_noise</span>
<span class="sd">            Whether to only plot the data for the single pure state (no noise).</span>
<span class="sd">        show_measured_probabilities_only</span>
<span class="sd">            Whether to only plot the basis-state probability distribution.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The figure containing the plot of the quantum state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">vpr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">vpr</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vpr</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">vpr_temp</span> <span class="o">=</span> <span class="n">vpr</span>

        <span class="k">def</span> <span class="nf">vpr</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">vpr_temp</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">vpr</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;vpr must be a float, None or a Callable[[int], float].&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">vpr</span><span class="p">(</span><span class="n">qubit_count</span><span class="p">))</span> <span class="o">*</span> <span class="mf">13.5</span><span class="p">))</span>

    <span class="n">tick_colour</span> <span class="o">=</span> <span class="n">convert_colour_to_float</span><span class="p">(</span><span class="n">tick_colour</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">interpolate</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">base_state_count</span> <span class="o">=</span> <span class="n">pure_probabilities_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># create new vectors that lerp between the sampled states with respect to sampled_state_number</span>
        <span class="n">pure_probabilities_start</span> <span class="o">=</span> <span class="n">pure_probabilities_list</span><span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">sampled_state_number</span><span class="p">)]</span>
        <span class="n">pure_probabilities_end</span> <span class="o">=</span> <span class="n">pure_probabilities_list</span><span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">sampled_state_number</span><span class="p">)]</span>
        <span class="n">pure_probabilities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pure_probabilities_start</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base_state_count</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pure_probabilities_start</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">pure_probabilities</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span>
                <span class="n">pure_probabilities_start</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">pure_probabilities_end</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">sampled_state_number</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">sampled_state_number</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">pure_phase_angles_start</span> <span class="o">=</span> <span class="n">pure_phase_angles_list</span><span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">sampled_state_number</span><span class="p">)]</span>
        <span class="n">pure_phase_angles_end</span> <span class="o">=</span> <span class="n">pure_phase_angles_list</span><span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">sampled_state_number</span><span class="p">)]</span>
        <span class="n">pure_phase_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">pure_phase_angles_start</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">base_state_count</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pure_phase_angles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">pure_phase_angles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span>
                <span class="n">pure_phase_angles_start</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">pure_phase_angles_end</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:],</span> <span class="n">sampled_state_number</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">sampled_state_number</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">measured_probabilities_start</span> <span class="o">=</span> <span class="n">measured_probabilities_list</span><span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">sampled_state_number</span><span class="p">)]</span>
        <span class="n">measured_probabilities_end</span> <span class="o">=</span> <span class="n">measured_probabilities_list</span><span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">sampled_state_number</span><span class="p">)]</span>
        <span class="n">measured_probabilities</span> <span class="o">=</span> <span class="n">lerp</span><span class="p">(</span>
            <span class="n">measured_probabilities_start</span><span class="p">[:],</span> <span class="n">measured_probabilities_end</span><span class="p">[:],</span> <span class="n">sampled_state_number</span> <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">sampled_state_number</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># avoid animating the phases when the probability&#39;s start or end point is zero</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pure_phase_angles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pure_phase_angles</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">pure_probabilities_start</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.0001</span> <span class="ow">and</span> <span class="n">pure_probabilities_end</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pure_phase_angles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pure_phase_angles_end</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">pure_probabilities_start</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pure_probabilities_end</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.0001</span><span class="p">:</span>
                    <span class="n">pure_phase_angles</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pure_phase_angles_start</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pure_probabilities</span> <span class="o">=</span> <span class="n">pure_probabilities_list</span><span class="p">[</span><span class="n">sampled_state_number</span><span class="p">]</span>
        <span class="n">pure_phase_angles</span> <span class="o">=</span> <span class="n">pure_phase_angles_list</span><span class="p">[</span><span class="n">sampled_state_number</span><span class="p">]</span>
        <span class="n">measured_probabilities</span> <span class="o">=</span> <span class="n">measured_probabilities_list</span><span class="p">[</span><span class="n">sampled_state_number</span><span class="p">]</span>
        <span class="n">base_state_count</span> <span class="o">=</span> <span class="n">pure_probabilities</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># A dictionary of plot names where the key is the plot name and the value is a matplotlib Axes object with a set position and size within the figure</span>
    <span class="n">plot_mosaic_dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># specify the plot mosaic layout</span>
    <span class="k">if</span> <span class="n">show_measured_probabilities_only</span><span class="p">:</span>
        <span class="c1"># only plot the basis-state probability distribution. No phases or noise-induced pure states.</span>
        <span class="n">fig_gridspec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
            <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="mf">0.07</span><span class="p">,</span>
            <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="mf">0.99</span><span class="p">,</span>
            <span class="s2">&quot;wspace&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="s2">&quot;hspace&quot;</span><span class="p">:</span> <span class="mf">0.09</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">plot_mosaic_dict</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="s2">&quot;meas_probs&quot;</span><span class="p">,</span> <span class="s2">&quot;meas_probs&quot;</span><span class="p">,</span> <span class="s2">&quot;meas_probs&quot;</span><span class="p">,</span> <span class="s2">&quot;meas_probs&quot;</span><span class="p">],</span>
                <span class="p">[</span><span class="s2">&quot;meas_probs&quot;</span><span class="p">,</span> <span class="s2">&quot;meas_probs&quot;</span><span class="p">,</span> <span class="s2">&quot;meas_probs&quot;</span><span class="p">,</span> <span class="s2">&quot;meas_probs&quot;</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="n">gridspec_kw</span><span class="o">=</span><span class="n">fig_gridspec</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">zero_noise</span><span class="p">:</span>
            <span class="c1"># only plot the first and only (when no noise) pure state probability distribution.</span>
            <span class="n">fig_gridspec</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
                <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
                <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="mf">0.07</span><span class="p">,</span>
                <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="mf">0.99</span><span class="p">,</span>
                <span class="s2">&quot;wspace&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
                <span class="s2">&quot;hspace&quot;</span><span class="p">:</span> <span class="mf">0.09</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">plot_mosaic_dict</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">[</span><span class="s2">&quot;pure_state:0&quot;</span><span class="p">,</span> <span class="s2">&quot;pure_state:0&quot;</span><span class="p">,</span> <span class="s2">&quot;pure_state:0&quot;</span><span class="p">,</span> <span class="s2">&quot;pure_state:0&quot;</span><span class="p">],</span>
                    <span class="p">[</span><span class="s2">&quot;pure_state:0&quot;</span><span class="p">,</span> <span class="s2">&quot;pure_state:0&quot;</span><span class="p">,</span> <span class="s2">&quot;pure_state:0&quot;</span><span class="p">,</span> <span class="s2">&quot;pure_state:0&quot;</span><span class="p">],</span>
                <span class="p">],</span>
                <span class="n">gridspec_kw</span><span class="o">=</span><span class="n">fig_gridspec</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Plot the probability distributions of the pure states in the mixed state</span>
            <span class="n">fig_gridspec</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;bottom&quot;</span><span class="p">:</span> <span class="mf">0.08</span><span class="p">,</span>
                <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="mf">0.95</span><span class="p">,</span>
                <span class="s2">&quot;left&quot;</span><span class="p">:</span> <span class="mf">0.07</span><span class="p">,</span>
                <span class="s2">&quot;right&quot;</span><span class="p">:</span> <span class="mf">0.99</span><span class="p">,</span>
                <span class="s2">&quot;wspace&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
                <span class="s2">&quot;hspace&quot;</span><span class="p">:</span> <span class="mf">0.09</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">plot_mosaic_dict</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">[</span><span class="s2">&quot;pure_state:1&quot;</span><span class="p">,</span> <span class="s2">&quot;pure_state:0&quot;</span><span class="p">,</span> <span class="s2">&quot;pure_state:0&quot;</span><span class="p">,</span> <span class="s2">&quot;pure_state:2&quot;</span><span class="p">],</span>
                    <span class="p">[</span><span class="s2">&quot;pure_state:3&quot;</span><span class="p">,</span> <span class="s2">&quot;pure_state:4&quot;</span><span class="p">,</span> <span class="s2">&quot;pure_state:5&quot;</span><span class="p">,</span> <span class="s2">&quot;pure_state:6&quot;</span><span class="p">],</span>
                <span class="p">],</span>
                <span class="n">gridspec_kw</span><span class="o">=</span><span class="n">fig_gridspec</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">num_qubits</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_state_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span>
    <span class="n">x_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">base_state_count</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">plot_name</span><span class="p">,</span> <span class="n">plot_axes</span> <span class="ow">in</span> <span class="n">plot_mosaic_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="n">pure_state_index</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">plot_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;pure_state&quot;</span><span class="p">:</span>
            <span class="n">pure_state_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">plot_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">plot_name</span> <span class="o">==</span> <span class="s2">&quot;meas_probs&quot;</span><span class="p">:</span>
            <span class="n">y_values</span> <span class="o">=</span> <span class="n">measured_probabilities</span>
        <span class="k">elif</span> <span class="n">pure_state_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pure_state_index</span> <span class="o">&lt;</span> <span class="n">pure_probabilities</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">y_values</span> <span class="o">=</span> <span class="n">pure_probabilities</span><span class="p">[</span><span class="n">pure_state_index</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">base_state_count</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: plot_name not recognised: &quot;</span> <span class="o">+</span> <span class="n">plot_name</span><span class="p">)</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">bar_list</span> <span class="o">=</span> <span class="n">plot_mosaic_dict</span><span class="p">[</span><span class="n">plot_name</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">y_values</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># set colour of the bars based on the phase</span>
        <span class="k">if</span> <span class="n">pure_state_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pure_state_index</span> <span class="o">&lt;</span> <span class="n">pure_probabilities</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">phase_angle</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pure_phase_angles</span><span class="p">[</span><span class="n">pure_state_index</span><span class="p">,</span> <span class="p">:]):</span>
                    <span class="c1"># Map phase angles from (-pi/2, pi/2] to (0, 1]</span>
                    <span class="n">colour_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">phase_angle</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                    <span class="n">bar_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">cmap_phase</span><span class="p">(</span><span class="n">colour_value</span><span class="p">))</span>

        <span class="n">plot_mosaic_dict</span><span class="p">[</span><span class="n">plot_name</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">base_state_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>
        <span class="n">plot_mosaic_dict</span><span class="p">[</span><span class="n">plot_name</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y_values</span><span class="p">)])</span>
        <span class="n">plot_mosaic_dict</span><span class="p">[</span><span class="n">plot_name</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">tick_colour</span><span class="p">)</span>
        <span class="n">plot_mosaic_dict</span><span class="p">[</span><span class="n">plot_name</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">tick_colour</span><span class="p">)</span>
        <span class="n">plot_mosaic_dict</span><span class="p">[</span><span class="n">plot_name</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">plot_mosaic_dict</span><span class="p">[</span><span class="n">plot_name</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plot_mosaic_dict</span><span class="p">[</span><span class="n">plot_name</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">zero_noise</span> <span class="ow">and</span> <span class="n">pure_state_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">plot_name</span> <span class="o">==</span> <span class="s2">&quot;meas_probs&quot;</span><span class="p">:</span>
            <span class="n">plot_mosaic_dict</span><span class="p">[</span><span class="n">plot_name</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pure_state_index</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">pure_state_index</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">plot_mosaic_dict</span><span class="p">[</span><span class="n">plot_name</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Set the x ticks and tick labels for important subplots</span>
        <span class="k">if</span> <span class="n">pure_state_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">plot_name</span> <span class="o">==</span> <span class="s2">&quot;meas_probs&quot;</span><span class="p">:</span>
            <span class="c1"># if there are too many qubits to fit all of the x ticks, then only draw a limited number</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">zero_noise</span> <span class="ow">and</span> <span class="n">num_qubits</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="ow">not</span> <span class="n">zero_noise</span><span class="p">)</span> <span class="ow">and</span> <span class="n">num_qubits</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">plot_name</span> <span class="o">==</span> <span class="s2">&quot;meas_probs&quot;</span> <span class="ow">and</span> <span class="n">num_qubits</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">):</span>
                <span class="n">x_ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">x_ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">base_state_count</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">))</span>
                <span class="n">x_ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">base_state_count</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">))</span>
                <span class="n">x_ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">base_state_count</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">))</span>
                <span class="n">x_ticks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">base_state_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_ticks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">base_state_count</span><span class="p">))</span>

            <span class="c1"># basis states are labelled in binary</span>
            <span class="n">x_tick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">bin</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">num_qubits</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_ticks</span><span class="p">]</span>

            <span class="n">plot_mosaic_dict</span><span class="p">[</span><span class="n">plot_name</span><span class="p">]</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plot_mosaic_dict</span><span class="p">[</span><span class="n">plot_name</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_ticks</span><span class="p">)</span>
            <span class="n">plot_mosaic_dict</span><span class="p">[</span><span class="n">plot_name</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">x_tick_labels</span><span class="p">)</span>
            <span class="n">plot_mosaic_dict</span><span class="p">[</span><span class="n">plot_name</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>

    <span class="c1"># Add axis labels</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="mf">0.01</span><span class="p">,</span>
        <span class="p">(</span><span class="n">fig_gridspec</span><span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fig_gridspec</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">fig_gridspec</span><span class="p">[</span><span class="s2">&quot;bottom&quot;</span><span class="p">],</span>
        <span class="s2">&quot;Probability&quot;</span><span class="p">,</span>
        <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="n">rotation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
        <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">fig_gridspec</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fig_gridspec</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">fig_gridspec</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">],</span> <span class="mf">0.035</span><span class="p">,</span> <span class="s2">&quot;Quantum states&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>


<span class="k">def</span> <span class="nf">_plot_info_panel</span><span class="p">(</span>
    <span class="n">output_manager</span><span class="p">:</span> <span class="n">data_manager</span><span class="o">.</span><span class="n">DataManager</span><span class="p">,</span>
    <span class="n">fig</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">],</span>
    <span class="n">pure_probabilities</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">pure_phase_angles</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">fidelity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">sampled_state_number</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">qubit_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">cmap_phase</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Colormap</span><span class="p">,</span>
    <span class="n">cmap_fidelity</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Colormap</span><span class="p">,</span>
    <span class="n">tick_colour</span><span class="p">:</span> <span class="n">Colour</span><span class="p">,</span>
    <span class="n">fidelity_line_colour</span><span class="p">:</span> <span class="n">Colour</span><span class="p">,</span>
    <span class="n">invert_colours</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">vpr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]],</span>
    <span class="n">draw_phase_wheel</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot the information panel corresponding to the given sampled state number and save it as a .png.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        output_manager</span>
<span class="sd">            Instance of DataManager for saving the figure.</span>
<span class="sd">        fig</span>
<span class="sd">            Matplotlib Figure instance to plot on. If None, a new figure is created.</span>
<span class="sd">        pure_probabilities</span>
<span class="sd">            A 2d array for the sampled state, where the array contains probabilities indexed by pure state number and basis state number.</span>
<span class="sd">        pure_phase_angles</span>
<span class="sd">            A 2d array for the sampled state, where the array contains phse angles indexed by pure state number and basis state number.</span>
<span class="sd">        fidelity</span>
<span class="sd">            The fidelity of the sampled state relative to the noiseless state.</span>
<span class="sd">        sampled_state_number</span>
<span class="sd">            The index number of the sampled state to be used when saving image to file.</span>
<span class="sd">        qubit_count</span>
<span class="sd">            The number of qubits in the quantum state.</span>
<span class="sd">        cmap_phase</span>
<span class="sd">            A colourmap for the phase angle colours in the phase wheel. The colourmap should map normalised phase angles [0,1] to colours.</span>
<span class="sd">        cmap_fidelity</span>
<span class="sd">            A colourmap for the fidelity bar. The colourmap should map normalised phase angles [0,1] to colours.</span>
<span class="sd">        tick_colour</span>
<span class="sd">            The colour of the tick marks.</span>
<span class="sd">        fidelity_line_colour</span>
<span class="sd">            The colour of the line marker on the fidelity bar.</span>
<span class="sd">        invert_colours</span>
<span class="sd">            Whether the colours are being inverted. Used to ensure that the colours are correct when the colours are inverted.</span>
<span class="sd">        vpr</span>
<span class="sd">            Propotion of vertical space that the circuit will occupy. Can be a float or a function that maps qubit_count (int) to float.</span>
<span class="sd">        draw_phase_wheel</span>
<span class="sd">            If True, only plot the phase wheel.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        The figure containing the plot of the quantum state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">vpr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">vpr</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vpr</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">vpr_temp</span> <span class="o">=</span> <span class="n">vpr</span>

        <span class="k">def</span> <span class="nf">vpr</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">vpr_temp</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">vpr</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;vpr must be a float, None or a Callable[[int], float].&quot;</span><span class="p">)</span>

    <span class="n">probabilities_0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pure_probabilities</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">phase_angles_0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pure_phase_angles</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">tick_colour</span> <span class="o">=</span> <span class="n">convert_colour_to_float</span><span class="p">(</span><span class="n">tick_colour</span><span class="p">)</span>
    <span class="n">fidelity_line_colour</span> <span class="o">=</span> <span class="n">convert_colour_to_float</span><span class="p">(</span><span class="n">fidelity_line_colour</span><span class="p">)</span>

    <span class="n">target_video_height_pixels</span> <span class="o">=</span> <span class="mi">1080</span>
    <span class="n">dpi</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.dpi&quot;</span><span class="p">]</span>
    <span class="n">target_empty_circuit_height_pixels</span> <span class="o">=</span> <span class="n">target_video_height_pixels</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">vpr</span><span class="p">(</span><span class="n">qubit_count</span><span class="p">))</span>
    <span class="n">fig_height_inches</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">vpr</span><span class="p">(</span><span class="n">qubit_count</span><span class="p">))</span> <span class="o">*</span> <span class="mf">13.5</span>
    <span class="n">fig_height_pixels</span> <span class="o">=</span> <span class="n">fig_height_inches</span> <span class="o">*</span> <span class="n">dpi</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">target_empty_circuit_height_pixels</span> <span class="o">/</span> <span class="n">fig_height_pixels</span>

    <span class="n">scaled_dpi</span> <span class="o">=</span> <span class="n">dpi</span> <span class="o">*</span> <span class="n">scale</span>

    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">vpr</span><span class="p">(</span><span class="n">qubit_count</span><span class="p">))</span> <span class="o">*</span> <span class="mf">13.5</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">scaled_dpi</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_dpi</span><span class="p">(</span><span class="n">scaled_dpi</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">draw_phase_wheel</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">_plot_phase_wheel</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">probabilities_0</span><span class="p">,</span> <span class="n">phase_angles_0</span><span class="p">,</span> <span class="n">cmap_phase</span><span class="p">,</span> <span class="n">tick_colour</span><span class="p">,</span> <span class="n">invert_colours</span><span class="p">)</span>
    <span class="n">_plot_stat_bars</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">fidelity</span><span class="p">,</span> <span class="n">cmap_fidelity</span><span class="p">,</span> <span class="n">fidelity_line_colour</span><span class="p">,</span> <span class="n">tick_colour</span><span class="p">,</span> <span class="n">invert_colours</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output_manager</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;info_panel_</span><span class="si">{</span><span class="n">sampled_state_number</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Gary Mooney.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-XXXXXXXXXX', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>